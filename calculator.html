<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>槌ポイント計算 (ループあり)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles if needed */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f4f8; /* Light background */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">槌ポイント計算 (ループあり)</h1>

        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">初期所持の槌</h2>
            <div class="flex items-center justify-between">
                <label for="initialWoodenHammer" class="text-gray-700">木槌:</label>
                <input type="number" id="initialWoodenHammer" value="0" min="0" class="w-24 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:border-blue-300">
            </div>

            <div class="flex items-center justify-between">
                <label for="initialIronHammer" class="text-gray-700">鉄槌:</label>
                <input type="number" id="initialIronHammer" value="0" min="0" class="w-24 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:border-blue-300">
            </div>

            <div class="flex items-center justify-between">
                <label for="initialCopperHammer" class="text-gray-700">銅槌:</label>
                <input type="number" id="initialCopperHammer" value="0" min="0" class="w-24 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:border-blue-300">
            </div>

            <div class="flex items-center justify-between">
                <label for="initialSilverHammer" class="text-gray-700">銀槌:</label>
                <input type="number" id="initialSilverHammer" value="0" min="0" class="w-24 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:border-blue-300">
            </div>

            <div class="flex items-center justify-between">
                <label for="initialGoldHammer" class="text-gray-700">金槌:</label>
                <input type="number" id="initialGoldHammer" value="0" min="0" class="w-24 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:border-blue-300">
            </div>
        </div>

        <button id="calculateFinalBtn" class="mt-6 w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring focus:ring-green-300 transition duration-200 ease-in-out">
            最終ポイント計算
        </button>

        <div class="mt-6 text-center text-lg font-semibold text-gray-800">
            最終合計ポイント: <span id="finalTotalPoints">0</span> Pt
        </div>

        <div class="mt-4 text-sm text-gray-600">
            <h3 class="font-semibold">獲得した槌の内訳:</h3>
            <p>木槌: <span id="gainedWooden">0</span>, 鉄槌: <span id="gainedIron">0</span>, 銅槌: <span id="gainedCopper">0</span>, 銀槌: <span id="gainedSilver">0</span>, 金槌: <span id="gainedGold">0</span></p>
        </div>
    </div>

    <script>
        // Get references to the input fields and result display
        const initialWoodenHammerInput = document.getElementById('initialWoodenHammer');
        const initialIronHammerInput = document.getElementById('initialIronHammer');
        const initialCopperHammerInput = document.getElementById('initialCopperHammer');
        const initialSilverHammerInput = document.getElementById('initialSilverHammer');
        const initialGoldHammerInput = document.getElementById('initialGoldHammer');
        const calculateFinalBtn = document.getElementById('calculateFinalBtn');
        const finalTotalPointsSpan = document.getElementById('finalTotalPoints');

        // Get references for gained hammers breakdown
        const gainedWoodenSpan = document.getElementById('gainedWooden');
        const gainedIronSpan = document.getElementById('gainedIron');
        const gainedCopperSpan = document.getElementById('gainedCopper');
        const gainedSilverSpan = document.getElementById('gainedSilver');
        const gainedGoldSpan = document.getElementById('gainedGold');

        // Define the point values for each hammer type
        const pointsPerHammer = {
            wooden: 1,
            iron: 10,
            copper: 20,
            silver: 50,
            gold: 0 // 金槌は0ポイント
        };

        // Define the points required to gain hammers and the hammer gained
        // threshold_diff: 前回の閾値からの差分ポイント
        // hammer: 獲得できる槌の種類
        const gainThresholds = [
            { threshold_diff: 10, hammer: 'iron' },    // 10Pt獲得で鉄槌
            { threshold_diff: 20, hammer: 'iron' },    // さらに20Pt獲得で鉄槌 (累計30Pt)
            { threshold_diff: 30, hammer: 'copper' },  // さらに30Pt獲得で銅槌 (累計60Pt)
            { threshold_diff: 40, hammer: 'silver' },  // さらに40Pt獲得で銀槌 (累計100Pt)
            { threshold_diff: 80, hammer: 'silver' },  // さらに80Pt獲得で銀槌 (累計180Pt)
            { threshold_diff: 100, hammer: 'silver' }, // さらに100Pt獲得で銀槌 (累計280Pt)
            { threshold_diff: 70, hammer: 'copper' },  // さらに70Pt獲得で銅槌 (累計350Pt)
            { threshold_diff: 50, hammer: 'silver' },  // さらに50Pt獲得で銀槌 (累計400Pt)
            { threshold_diff: 100, hammer: 'gold' }     // さらに100Pt獲得で金槌 (累計500Pt)
        ];

        /**
         * Calculates the total points from a given set of hammers.
         * @param {object} hammers - An object containing the count of each hammer type.
         * @returns {number} The total points.
         */
        function calculatePointsFromHammers(hammers) {
            let total = 0;
            total += (hammers.wooden || 0) * pointsPerHammer.wooden;
            total += (hammers.iron || 0) * pointsPerHammer.iron;
            total += (hammers.copper || 0) * pointsPerHammer.copper;
            total += (hammers.silver || 0) * pointsPerHammer.silver;
            total += (hammers.gold || 0) * pointsPerHammer.gold;
            return total;
        }

        // Add event listener to the button
        calculateFinalBtn.addEventListener('click', () => {
            // Get the initial number of each hammer
            let hammersForNextIteration = {
                wooden: parseInt(initialWoodenHammerInput.value) || 0,
                iron: parseInt(initialIronHammerInput.value) || 0,
                copper: parseInt(initialCopperHammerInput.value) || 0,
                silver: parseInt(initialSilverHammerInput.value) || 0,
                gold: parseInt(initialGoldHammerInput.value) || 0
            };

            let totalPointsEarned = 0;
            let currentCyclePointAccumulation = 0; // 現在の報酬サイクル内で蓄積されたポイント
            let currentThresholdIndex = 0; // 現在チェックしている閾値のインデックス (0からgainThresholds.length-1)
            const totalGainedHammers = { wooden: 0, iron: 0, copper: 0, silver: 0, gold: 0 };

            // Iterative calculation loop
            // ループは、次のイテレーションで処理すべきハンマーがあるか、
            // または獲得したポイントで新たな閾値を超えられる限り続きます。
            let iterationCount = 0;
            const maxIterations = 20000; // 無限ループ防止のための最大試行回数を増やしました

            while (iterationCount < maxIterations) {
                // このイテレーションで処理するハンマーを取得し、次のイテレーション用のリストをリセット
                const currentHammers = hammersForNextIteration;
                hammersForNextIteration = { wooden: 0, iron: 0, copper: 0, silver: 0, gold: 0 }; // 次のラウンドで獲得するハンマー用

                // 現在所持している槌から得られるポイントを計算
                const pointsFromCurrentHammers = calculatePointsFromHammers(currentHammers);

                // もし現在のハンマーからポイントが得られない、かつ、このラウンドで新たなハンマーも獲得できない場合、ループを終了
                // これは、ポイント源となるハンマーが全て消費され、かつ、蓄積ポイントでも新たなハンマーが得られない状態です。
                 if (pointsFromCurrentHammers === 0 && Object.values(currentHammers).every(count => count === 0)) {
                    // ただし、pointsFromCurrentHammersが0でも、currentCyclePointAccumulationに
                    // 過去のラウンドの残りポイントがあり、それが閾値を超える可能性があるので、
                    // hammerGainedInThisIteration フラグも考慮する必要があります。
                 }


                // 獲得したポイントを累計ポイントに加算
                totalPointsEarned += pointsFromCurrentHammers;
                // 現在の報酬サイクル内の蓄積ポイントに加算
                currentCyclePointAccumulation += pointsFromCurrentHammers;

                let gainedAnyHammerThisRound = false; // このイテレーションで槌を獲得したかどうかのフラグ

                // 累計ポイントで達成できる閾値をチェックし、槌を獲得
                // 現在の閾値インデックスから開始し、達成できる限りチェックを続ける
                while (true) {
                    // 次にチェックする閾値のポイント差分
                    const pointsNeededForNextThreshold = gainThresholds[currentThresholdIndex].threshold_diff;

                    // 現在のサイクル内蓄積ポイントが次の閾値差分以上であれば、槌を獲得
                    if (currentCyclePointAccumulation >= pointsNeededForNextThreshold) {
                        const hammerTypeToGain = gainThresholds[currentThresholdIndex].hammer;

                        // 獲得した槌を totalGainedHammers に加算 (最終的な内訳用)
                        totalGainedHammers[hammerTypeToGain]++;
                        // 獲得した槌を次のイテレーションで処理するハンマーリストに加算
                        hammersForNextIteration[hammerTypeToGain]++;
                        gainedAnyHammerThisRound = true; // 槌を獲得したことを記録

                        // 獲得に使用したポイントをサイクル内蓄積ポイントから減算
                        currentCyclePointAccumulation -= pointsNeededForNextThreshold;

                        // 次の閾値インデックスに進む
                        currentThresholdIndex++;

                        // 閾値リストの最後に達したら、最初の閾値に戻る（ループ）
                        if (currentThresholdIndex >= gainThresholds.length) {
                            currentThresholdIndex = 0;
                            // サイクル内蓄積ポイントの残りはそのまま次のサイクルの開始ポイントとなる
                        }
                    } else {
                        // サイクル内蓄積ポイントが次の閾値差分に満たない場合、このイテレーションでの閾値チェックは終了
                        break;
                    }
                }

                // このイテレーションで新たな槌を獲得しなかった、かつ、現在の槌からポイントが得られなかった場合、ループを終了
                // ポイントが得られなかった（pointsFromCurrentHammers === 0）かつ、
                // 獲得したポイントで新たな槌も得られなかった（!gainedAnyHammerThisRound）場合に停止します。
                if (pointsFromCurrentHammers === 0 && !gainedAnyHammerThisRound) {
                    break;
                }

                iterationCount++;
            }

            if (iterationCount >= maxIterations) {
                console.warn("最大試行回数に達しました。計算が収束しない可能性があります。");
                // 無限ループの可能性を示唆する場合、ユーザーに通知するなどの処理を追加することもできます。
            }

            // 最終的な累計ポイントを表示
            finalTotalPointsSpan.textContent = totalPointsEarned;

            // 獲得した槌の内訳を表示
            gainedWoodenSpan.textContent = totalGainedHammers.wooden;
            gainedIronSpan.textContent = totalGainedHammers.iron;
            gainedCopperSpan.textContent = totalGainedHammers.copper;
            gainedSilverSpan.textContent = totalGainedHammers.silver;
            gainedGoldSpan.textContent = totalGainedHammers.gold;
        });
    </script>
</body>
</html>
